<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UK COVID‑19 Heatmap (LTLA, latest 7‑day rate)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    #map { height: 100vh; }
    .info {
      padding: 8px 12px;
      background: rgba(255,255,255,0.95);
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      border-radius: 6px;
      line-height: 1.2;
    }
    .legend {
      line-height: 18px;
      color: #555;
      background: rgba(255,255,255,0.95);
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
    }
    .legend i {
      width: 18px; height: 18px; float: left; margin-right: 8px; opacity: 0.7;
    }
    .attribution { position: absolute; bottom: 8px; left: 8px; background: rgba(255,255,255,0.9); padding: 6px 8px; border-radius: 6px; font-size: 12px;}
    .topbar {
      position: absolute; top: 10px; left: 10px; z-index: 1000;
      display: flex; gap: 8px; align-items: center;
      background: rgba(255,255,255,0.98); padding: 8px 10px; border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.15);
    }
    .topbar select, .topbar button { font-size: 14px; padding: 6px 8px; }
    .status { font-size: 12px; color: #555; }
    .toast {
      position: absolute; right: 10px; top: 10px; z-index: 1100;
      background: #fee; color: #900; padding: 10px 12px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,.2);
      display: none; max-width: 360px;
    }
    .spinner {
      position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
      border: 6px solid #eee; border-top: 6px solid #888; border-radius: 50%; width: 48px; height: 48px;
      animation: spin 0.8s linear infinite; z-index: 900; display:none;
    }
    @keyframes spin { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }
  </style>
</head>
<body>
  <div class="topbar">
    <strong>Metric:</strong>
    <select id="metric">
      <option value="newCasesByPublishDateRollingRate" selected>7‑day cases/100k (rolling)</option>
      <option value="newCasesByPublishDate">New cases (daily)</option>
    </select>
    <button id="refresh">Refresh</button>
    <span id="status" class="status"></span>
  </div>
  <div id="map"></div>
  <div class="spinner" id="spinner"></div>
  <div class="toast" id="toast"></div>
  <div class="attribution">
    Data: UKHSA COVID‑19 API & ONS boundaries. Map © OpenStreetMap contributors, © Leaflet.
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Helpers
    const spinner = document.getElementById('spinner');
    const toast = document.getElementById('toast');
    const showSpinner = (b) => spinner.style.display = b ? 'block' : 'none';
    const showToast = (msg) => { toast.textContent = msg; toast.style.display = 'block'; setTimeout(()=> toast.style.display='none', 7000); };

    // Map init
    let map;
    try {
      map = L.map('map', { zoomSnap: 0.5 }).setView([54.5, -3.2], 5.4);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 10,
        attribution: "&copy; OpenStreetMap contributors"
      }).addTo(map);
    } catch(e) {
      showToast('Leaflet failed to load: ' + e.message);
    }

    // Global refs
    let geoLayer;
    let latestDate = null;
    let metricKey = document.getElementById('metric').value;

    const statusEl = document.getElementById('status');
    const refreshBtn = document.getElementById('refresh');
    const metricSelect = document.getElementById('metric');

    metricSelect.addEventListener('change', () => { metricKey = metricSelect.value; drawChoropleth(); });
    refreshBtn.addEventListener('click', () => { fetchAndRender().catch(err => console.error(err)); });

    // Color scale
    function getColor(d){
      return d == null ? '#f0f0f0' :
             d > 300 ? '#800026' :
             d > 200 ? '#BD0026' :
             d > 150 ? '#E31A1C' :
             d > 100 ? '#FC4E2A' :
             d > 60  ? '#FD8D3C' :
             d > 30  ? '#FEB24C' :
             d > 10  ? '#FED976' :
                       '#FFEDA0';
    }

    function style(feature) {
      const props = feature.properties || {};
      const d = (props.__covid && props.__covid[metricKey] != null) ? props.__covid[metricKey] : null;
      return { fillColor: getColor(d), weight: 0.6, opacity: 1, color: '#777', dashArray: '1', fillOpacity: 0.8 };
    }

    function onEachFeature(feature, layer){
      const p = feature.properties || {};
      const c = p.__covid || {};
      const rate = c.newCasesByPublishDateRollingRate;
      const newCases = c.newCasesByPublishDate;
      const date = c.date || latestDate || '—';
      const name = p.lad_name || p.LAD23NM || p.name || p.NM || 'Area';
      const code = p.lad_code || p.LAD23CD || p.code || '';
      const html = `
        <div class="info">
          <strong>${name}</strong><br/>
          <div>${date ? 'Date: ' + date : ''}</div>
          <div>7‑day rate/100k: <strong>${(rate ?? 'N/A')}</strong></div>
          <div>New cases (daily): <strong>${(newCases ?? 'N/A')}</strong></div>
          <div style="margin-top:6px;font-size:11px;color:#666;">code: ${code}</div>
        </div>`;
      layer.bindPopup(html);
      layer.on({
        mouseover: (e) => { const l = e.target; l.setStyle({ weight: 2, color: '#111', fillOpacity: 0.85 }); l.bringToFront(); },
        mouseout: (e) => { geoLayer.resetStyle(e.target); }
      });
    }

    const legend = L.control({position: 'bottomright'});
    legend.onAdd = function () {
      const div = L.DomUtil.create('div', 'legend'),
        grades = [0,10,30,60,100,150,200,300],
        labels = [];
      div.innerHTML += '<strong>7‑day cases / 100k</strong><br>';
      for (let i = 0; i < grades.length; i++) {
        const from = grades[i];
        const to = grades[i + 1];
        const color = getColor(from + 0.1);
        labels.push('<i style="background:' + color + '"></i> ' + from + (to ? '&ndash;' + to : '+'));
      }
      div.innerHTML += labels.join('<br>');
      return div;
    };
    legend.addTo(map);

    async function fetchAllLTLA(metricLatestBy='newCasesByPublishDateRollingRate') {
      let page = 1;
      const all = [];
      const structure = {
        areaCode: "areaCode",
        areaName: "areaName",
        date: "date",
        newCasesByPublishDateRollingRate: "newCasesByPublishDateRollingRate",
        newCasesByPublishDate: "newCasesByPublishDate"
      };
      while(true){
        const url = new URL('https://api.coronavirus.data.gov.uk/v1/data');
        url.searchParams.set('filters', 'areaType=ltla');
        url.searchParams.set('latest_by', metricLatestBy);
        url.searchParams.set('structure', JSON.stringify(structure));
        url.searchParams.set('page', page);
        const resp = await fetch(url.toString(), { headers: { 'Accept': 'application/json' }});
        if(!resp.ok) throw new Error('UKHSA API error: ' + resp.status + ' ' + (await resp.text()));
        const json = await resp.json();
        const data = (json && json.data) ? json.data : [];
        if(!data.length) break;
        all.push(...data);
        page += 1;
        if(page > 40) break;
      }
      if(all.length){ latestDate = all[0].date; }
      return all;
    }

    async function loadGeoJSON() {
      // Primary: ONS ArcGIS Feature Service (UK-wide LAD 2023, clipped to coastline if available)
      const primary = 'https://services1.arcgis.com/ESMARspQHYMw9BZ9/arcgis/rest/services/Local_Authority_Districts_December_2023_UK_BFE_V2/FeatureServer/0/query?where=1%3D1&outFields=LAD23CD%2CLAD23NM&outSR=4326&f=geojson';
      // Backup: GitHub raw (may be slower / CORS-dependent)
      const backup = 'https://raw.githubusercontent.com/martinjc/UK-GeoJSON/master/json/administrative/uk/lad.json';

      // Try primary
      let resp = await fetch(primary);
      if(resp.status === 403) {
        console.warn('Primary boundaries returned 403, trying backup…');
      }
      if(resp.ok) {
        const gj = await resp.json();
        // Ensure standard property naming
        gj.features.forEach(f => {
          f.properties = f.properties || {};
          const p = f.properties;
          if(p.LAD23CD && !p.lad_code) p.lad_code = p.LAD23CD;
          if(p.LAD23NM && !p.lad_name) p.lad_name = p.LAD23NM;
        });
        return gj;
      }
      // Fallback
      resp = await fetch(backup);
      if(!resp.ok) throw new Error('GeoJSON fetch error (all sources): ' + resp.status);
      return resp.json();
    }

    function indexCovidByCode(rows){
      const idx = new Map();
      rows.forEach(r => { if(r.areaCode){ idx.set(r.areaCode, r); } });
      return idx;
    }

    function attachCovidToFeatures(geojson, covidIndex){
      for(const f of geojson.features){
        const p = f.properties || (f.properties = {});
        const code = p.lad_code || p.lad19cd || p.lad18cd || p.LAD24CD || p.LAD23CD || p.ladcode || p.code || p.LAD13CD || p.lad17cd || p.LAD16CD;
        const name = p.lad_name || p.lad19nm || p.lad18nm || p.LAD24NM || p.LAD23NM || p.ladnm || p.name || p.LAD13NM || p.lad17nm || p.LAD16NM;
        if(code && !p.lad_code) p.lad_code = code;
        if(name && !p.lad_name) p.lad_name = name;
        const match = code ? covidIndex.get(code) : null;
        p.__covid = match ? match : {};
      }
      return geojson;
    }

    let cachedGeo = null;
    let cachedCovidIdx = null;

    async function fetchAndRender(){
      try {
        showSpinner(true);
        statusEl.textContent = 'Loading boundaries & latest COVID data…';
        if(!cachedGeo){
          cachedGeo = await loadGeoJSON();
        }
        const covidRows = await fetchAllLTLA('newCasesByPublishDateRollingRate');
        cachedCovidIdx = indexCovidByCode(covidRows);
        statusEl.textContent = `Latest date: ${latestDate || ''} • Areas: ${covidRows.length}`;
        drawChoropleth();
      } catch(err){
        console.error(err);
        showToast(err.message || String(err));
        statusEl.textContent = 'Error: ' + (err.message || String(err));
      } finally {
        showSpinner(false);
      }
    }

    function drawChoropleth(){
      if(!cachedGeo || !cachedCovidIdx) return;
      if(geoLayer){ geoLayer.remove(); }
      const enriched = attachCovidToFeatures(JSON.parse(JSON.stringify(cachedGeo)), cachedCovidIdx);
      geoLayer = L.geoJSON(enriched, { style, onEachFeature }).addTo(map);
      try { map.fitBounds(geoLayer.getBounds(), { padding: [10,10] }); } catch(e) {}
    }

    // Kick off
    fetchAndRender().catch(err => {
      console.error(err);
      showToast('Startup error: ' + err.message);
      statusEl.textContent = 'Error: ' + err.message;
    });
  </script>
</body>
</html>
