<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pixel-Art 3D Flower (HTML5 + Three.js)</title>
  <style>
    html, body { height: 100%; margin: 0; background: #0e0f12; }
    #app { position: fixed; inset: 0; }
    canvas { image-rendering: pixelated; display: block; }
    .ui {
      position: fixed; left: 12px; top: 12px; z-index: 10;
      display: flex; gap: 8px; flex-wrap: wrap;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    .btn {
      appearance: none; border: 0; cursor: pointer; font-weight: 600;
      padding: 8px 12px; border-radius: 12px; background: #1f2937; color: #f3f4f6;
      box-shadow: 0 6px 20px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.05);
      transition: transform .08s ease, filter .2s ease;
    }
    .btn:hover { filter: brightness(1.2); }
    .btn:active { transform: translateY(1px); }
    .badge { padding: 8px 12px; border-radius: 12px; background: #0b7; color: #031;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.35);
      font-weight: 700;
    }
  </style>
</head>
<body>
  <div id="app"></div>
  <div class="ui">
    <button id="exportGlb" class="btn">Export as .glb</button>
    <button id="toggleGrid" class="btn">Toggle Grid</button>
    <span id="stats" class="badge" title="Voxel count">â€”</span>
  </div>

  <script type="module">
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js';
    import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/OrbitControls.js';
    import { GLTFExporter } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/exporters/GLTFExporter.js';

    // --- Renderer -----------------------------------------------------------
    const container = document.getElementById('app');
    const renderer = new THREE.WebGLRenderer({ antialias: false, alpha: true, powerPreference: 'high-performance' });
    // Keep pixels blocky
    renderer.setPixelRatio(1);
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    renderer.shadowMap.enabled = false;
    container.appendChild(renderer.domElement);

    // --- Scene & Camera -----------------------------------------------------
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x101218);

    const d = 24; // ortho frustum size
    const camera = new THREE.OrthographicCamera(-d, d, d, -d, 0.1, 1000);
    camera.position.set(24, 24, 24);
    camera.lookAt(0, 8, 0);
    camera.zoom = 24 / d * 1.2; // mild zoom to frame nicely
    camera.updateProjectionMatrix();

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.06;
    controls.target.set(0, 8, 0);

    // --- Lights ------------------------------------------------------------
    const hemi = new THREE.HemisphereLight(0xffffff, 0x152026, 0.85);
    scene.add(hemi);

    const dir = new THREE.DirectionalLight(0xffffff, 0.35);
    dir.position.set(12, 24, 12);
    scene.add(dir);

    // --- Grid / Ground -----------------------------------------------------
    const grid = new THREE.GridHelper(40, 40, 0x335566, 0x1b2a33);
    grid.position.y = 0;
    grid.material.opacity = 0.35;
    grid.material.transparent = true;
    scene.add(grid);

    // Low, glossy ground plate to catch some light
    const ground = new THREE.Mesh(
      new THREE.BoxGeometry(18, 0.5, 18),
      new THREE.MeshStandardMaterial({ color: 0x0f1720, roughness: 0.9, metalness: 0.1 })
    );
    ground.position.set(0, -0.26, 0);
    scene.add(ground);

    // --- Voxel Builder ------------------------------------------------------
    const flower = new THREE.Group();
    flower.name = 'PixelFlower';
    scene.add(flower);

    const boxGeo = new THREE.BoxGeometry(1, 1, 1);
    const MAT = {
      stem:   new THREE.MeshStandardMaterial({ color: 0x2e7d32, roughness: 1.0, metalness: 0.0, flatShading: true }), // green
      leaf:   new THREE.MeshStandardMaterial({ color: 0x3fa34d, roughness: 1.0, metalness: 0.0, flatShading: true }), // lighter green
      center: new THREE.MeshStandardMaterial({ color: 0xf2c94c, roughness: 0.95, metalness: 0.0, flatShading: true }), // yellow
      petal:  new THREE.MeshStandardMaterial({ color: 0xff6b6b, roughness: 0.95, metalness: 0.0, flatShading: true }), // red/pink
      petal2: new THREE.MeshStandardMaterial({ color: 0xff9aa2, roughness: 0.95, metalness: 0.0, flatShading: true }), // highlight
      soil:   new THREE.MeshStandardMaterial({ color: 0x5d4037, roughness: 1.0, metalness: 0.0, flatShading: true })  // brown
    };

    let voxelCount = 0;
    function addVoxel(x, y, z, mat) {
      // Shift up by 0.5 so the model sits exactly on y=0
      const m = new THREE.Mesh(boxGeo, mat);
      m.position.set(x, y + 0.5, z);
      flower.add(m);
      voxelCount++;
      return m;
    }

    // Build a small plinth/soil base (14x14, 1 high)
    for (let x = -7; x <= 7; x++) {
      for (let z = -7; z <= 7; z++) {
        // Add a slight chamfer by skipping corners
        if (Math.abs(x) === 7 && Math.abs(z) === 7) continue;
        addVoxel(x, -1, z, MAT.soil);
      }
    }

    // Stem (tall column)
    for (let y = 0; y <= 8; y++) {
      addVoxel(0, y, 0, MAT.stem);
    }

    // Leaves (simple angled clusters at y=2 and y=4)
    const leafShapes = [
      [ [1,2,0], [2,2,0], [2,3,0], [3,3,0] ],   // right leaf
      [ [-1,4,0], [-2,4,0], [-2,5,0], [-3,5,0] ] // left leaf
    ];
    leafShapes.forEach(points => points.forEach(([x,y,z]) => addVoxel(x,y,z, MAT.leaf)));

    // Flower center (a 3x3x2 yellow core)
    for (let y = 9; y <= 10; y++) {
      for (let x = -1; x <= 1; x++) {
        for (let z = -1; z <= 1; z++) {
          addVoxel(x, y, z, MAT.center);
        }
      }
    }

    // Petals ring (5x5 shell around the core on two layers)
    function onRing(x, z) { return Math.abs(x) === 2 || Math.abs(z) === 2; }
    [9, 10].forEach(y => {
      for (let x = -2; x <= 2; x++) {
        for (let z = -2; z <= 2; z++) {
          if (!onRing(x, z)) continue;
          const mat = (y === 10 && (Math.abs(x) + Math.abs(z)) % 2 === 0) ? MAT.petal2 : MAT.petal;
          addVoxel(x, y, z, mat);
        }
      }
    });

    // A little crown on top
    [ [0,11,0], [0,11,1], [1,11,0], [0,11,-1], [-1,11,0] ].forEach(([x,y,z]) => addVoxel(x,y,z, MAT.petal2));

    // Update voxel counter badge
    document.getElementById('stats').textContent = `${voxelCount} voxels`;

    // --- Resize Handling (for crisp pixel look) ----------------------------
    function resize() {
      const w = window.innerWidth;
      const h = window.innerHeight;

      // Render internally at half resolution, upscale via CSS for chunky pixels
      const scale = 0.5; // tweak between 0.33 - 1.0 for more/less pixelation
      renderer.setSize(Math.max(1, w * scale), Math.max(1, h * scale), false);
      renderer.domElement.style.width = w + 'px';
      renderer.domElement.style.height = h + 'px';

      const aspect = w / h;
      camera.left   = -d * aspect;
      camera.right  =  d * aspect;
      camera.top    =  d;
      camera.bottom = -d;
      camera.updateProjectionMatrix();
    }
    window.addEventListener('resize', resize);
    resize();

    // --- Export .glb -------------------------------------------------------
    const exporter = new GLTFExporter();
    document.getElementById('exportGlb').addEventListener('click', () => {
      exporter.parse(
        flower,
        (result) => {
          // result is an ArrayBuffer when binary:true
          const blob = new Blob([result], { type: 'model/gltf-binary' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'pixel_flower.glb';
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        },
        { binary: true }
      );
    });

    // --- Toggle Grid -------------------------------------------------------
    document.getElementById('toggleGrid').addEventListener('click', () => {
      grid.visible = !grid.visible;
    });

    // --- Animate -----------------------------------------------------------
    let t = 0;
    function animate() {
      requestAnimationFrame(animate);
      // subtle idle motion for life
      t += 0.01;
      const sway = Math.sin(t) * 0.03;
      flower.rotation.y = 0.25 + sway;

      controls.update();
      renderer.render(scene, camera);
    }
    animate();
  </script>
</body>
</html>
